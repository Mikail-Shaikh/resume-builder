<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resume & Cover Letter Tailoring Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.1.0/docx.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f9;
        }
        h1 {
            color: #333;
        }
        label {
            font-weight: bold;
        }
        input[type="password"], input[type="file"], textarea, button {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        #output {
            margin-top: 20px;
        }
        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Resume & Cover Letter Tailoring Tool</h1>
    <p>Upload your resume and cover letter (.docx), input the job description, and tailor both documents using GPT.</p>

    <label for="api_key">OpenAI API Key:</label>
    <input type="password" id="api_key" placeholder="Enter your OpenAI API key" required>

    <label for="resume_file">Upload Resume (.docx):</label>
    <input type="file" id="resume_file" accept=".docx" required>

    <label for="cover_letter_file">Upload Cover Letter (.docx):</label>
    <input type="file" id="cover_letter_file" accept=".docx" required>

    <label for="job_description">Job Description:</label>
    <textarea id="job_description" rows="6" placeholder="Paste the job description here" required></textarea>

    <button onclick="tailorDocuments()">Tailor Documents</button>

    <div id="output">
        <h2>Download Tailored Documents</h2>
        <button id="download_resume_button" style="display:none;" onclick="downloadResume()">Download Tailored Resume (.docx)</button>
        <button id="download_cover_letter_button" style="display:none;" onclick="downloadCoverLetter()">Download Tailored Cover Letter (.docx)</button>
    </div>
</div>

<script>
    // Function to read a Word document and extract text from it
    async function readDocxFile(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (event) => {
                const arrayBuffer = event.target.result;
                docx.Packer.load(arrayBuffer).then(doc => {
                    const paragraphs = doc.body.paragraphs.map(paragraph => {
                        return paragraph.children.map(child => child.text).join("");
                    }).join("\n");
                    resolve({ doc, paragraphs });
                }).catch(err => reject(err));
            };
            reader.onerror = (error) => reject(error);
            reader.readAsArrayBuffer(file);
        });
    }

    // Function to tailor both the resume and cover letter by sending extracted text to OpenAI
    async function tailorDocuments() {
        const apiKey = document.getElementById('api_key').value;
        const resumeFile = document.getElementById('resume_file').files[0];
        const coverLetterFile = document.getElementById('cover_letter_file').files[0];
        const jobDescription = document.getElementById('job_description').value;

        if (!apiKey || !resumeFile || !coverLetterFile || !jobDescription) {
            alert("Please fill in all fields.");
            return;
        }

        try {
            // Step 1: Read the resume and cover letter files and extract their text
            const { doc: resumeDoc, paragraphs: resumeText } = await readDocxFile(resumeFile);
            const { doc: coverLetterDoc, paragraphs: coverLetterText } = await readDocxFile(coverLetterFile);

            // Combine the resume text into a single string
            const resumePlainText = resumeText.join("\n");

            const promptForCoverLetter = `
            Here is the original cover letter in plain text format:

            ${coverLetterText.join("\n")}

            Here is a resume in plain text format:

            ${resumePlainText}

            Here is the job description:

            ${jobDescription}

            Tailor the cover letter to this job description by including keywords, minimum requirements, and relevant experience from the resume. Ensure the cover letter retains the original professional tone and overall format. Return the tailored cover letter in plain text format.
            `;

            const endpoint = 'https://api.openai.com/v1/completions';

            // Step 2: Make API call to OpenAI to tailor the cover letter
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: "text-davinci-003",
                    prompt: promptForCoverLetter,
                    max_tokens: 2048,
                    temperature: 0.7
                })
            });

            const data = await response.json();
            const tailoredCoverLetterText = data.choices[0].text.trim();

            // Step 3: Replace the original cover letter text with the tailored content and preserve formatting
            applyTailoredTextToDocx(coverLetterDoc, tailoredCoverLetterText, 'coverLetter');

            // Enable the download buttons for both the resume and cover letter
            document.getElementById("download_cover_letter_button").style.display = "inline";

        } catch (error) {
            console.error('Error:', error);
            alert("There was an error tailoring your documents. Please check the API key and try again.");
        }
    }

    // Function to apply tailored text to the original document structure
    function applyTailoredTextToDocx(doc, tailoredText, type) {
        const tailoredParagraphs = tailoredText.split("\n");
        // Replace the text in the original document structure with the tailored content
        doc.body.paragraphs.forEach((paragraph, index) => {
            if (tailoredParagraphs[index]) {
                paragraph.children.forEach((child, childIndex) => {
                    if (tailoredParagraphs[index][childIndex]) {
                        child.text = tailoredParagraphs[index][childIndex];
                    }
                });
            }
        });

        if (type === 'coverLetter') {
            document.getElementById("download_cover_letter_button").doc = doc;
        }
    }

    // Function to trigger download of tailored cover letter as .docx
    function downloadCoverLetter() {
        const doc = document.getElementById("download_cover_letter_button").doc;
        docx.Packer.toBlob(doc).then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "tailored_cover_letter.docx";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });
    }
</script>

</body>
</html>
